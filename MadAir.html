<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>MadAir: A Phaser Game</title>
	<link href='http://fonts.googleapis.com/css?family=Audiowide' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            font-family: Audiowide, sans-serif;
        }

        .air_msg
        {
        	color: pink;
        	font-family: Audiowide, sans-serif;
        	font-size: 3em;
        	text-align: center;
        	z-index: 10;
        }

        #msgContainer
        {
        	position: absolute;
        	margin: 0 auto;
        	/*float: left;*/
        	margin-left: 300px;
        }

    </style>
</head>
<body>
<div id = "msgContainer">
	<!-- <div id="#air_msg">GOT MAD AIR!</div> -->
</div>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

var score = 0;
var scoreText;
var diveRate = 100;
var nextDive = 0;
var canDive = true;
var isDiving = false;
var numMadAirs = 10;
var bounceText;
var madAirsGrabbed = 0;
var timerText;
var finished = false;
var numStars = 20;
var dudeIsGood = true;
var myFontPost = "px Audiowide";

function preload() {
	//game.load.image("sky", "assets/sky.png");
	game.load.image("ground", "assets/platform.png");
	game.load.image("star", "assets/star.png");
	game.load.spritesheet("dude", "assets/dude.png", 32, 48);
	game.load.image("bonus", "assets/diamond.png");
	//game.load.spritesheet("baddie", "assets/baddie.png", 32, 48);
	//game.load.image("baddie", "assets/firstAid.png");
	game.load.image("baddie", "assets/goomba.png");
}

function create() {

	game.world.setBounds(0, 0, 1600, 600);

	//game.add.sprite(0,0,"sky");

	game.stage.backgroundColor = "#14aaff";


	platforms = game.add.group();


	var ground = platforms.create(0, game.world.height - 64, "ground");
	ground.body.immovable = true;
	for (var i = 400; i < game.world.width; i += 400)
	{
		ground = platforms.create(i, game.world.height - 64, "ground");
		ground.body.immovable = true;
	}
	//console.log(ground.width + "Hello");

	ground.scale.setTo(2, 2);

	ground.body.immovable = true;

	var ledge = platforms.create(400, 400, "ground");

	ledge.body.immovable = true;

	ledge = platforms.create(-150, 250, "ground");

	ledge.body.immovable = true;

	player = game.add.sprite(32, game.world.height - 150, "dude");

	player.body.bounce.y = 0.2;
	player.body.gravity.y = 6.0;
	player.body.collideWorldBounds = true;

	game.camera.follow(player);
	//player.body.blocked = {x:0, y:0, up: false, bottom: true, left: true, right: true};

	player.animations.add("left", [0,1,2,3], 10, true);
	player.animations.add("right", [5,6,7,8], 10, true);

	cursors = game.input.keyboard.createCursorKeys();

	scoreText = game.add.text(16, 16, "Score: 0/" + numStars, {font: '20px Audiowide', fill: "darkorchid"});
	//scoreText.follow(player);
	//scoreText.fixedToCamera = true;
	// scoreText.fixedToCamera = true;
	// scoreText.cameraOffset.setTo(0,0);

	myEnemies = game.add.group();

	var baddie = myEnemies.create(200, game.world.height-150, "baddie");
	baddie.body.gravity.y = 6;
	for (var i = Math.floor(Math.random()*250); i < game.world.width; i+= Math.floor(Math.random()*300))
	{
		baddie = myEnemies.create(200 + i, game.world.height - 150, "baddie");
		baddie.body.gravity.y = 6;
		baddie.body.collideWorldBounds = true;
		//baddie.dirTimer = 5000;
	}

	baddie = myEnemies.create(600, 350, "baddie");
	baddie.body.gravity.y = 6;
	baddie.body.collideWorldBounds = true;

	baddie = myEnemies.create(725, 350, "baddie");
	baddie.body.gravity.y = 6;
	baddie.body.collideWorldBounds = true;

	baddie = myEnemies.create(25, 200, "baddie");
	baddie.body.gravity.y = 6;
	baddie.body.collideWorldBounds = true;


	// antiDude = game.add.sprite(200, game.world.height-150, "baddie");
	// antiDude.body.gravity.y = 6;
	// antiDude.body.collideWorldBounds = true;



	bounceText = game.add.text(16, 64, madAirToString(), {font: '10px Audiowide', fill: "chartreuse"});
	timerText = game.add.text(16, 88, "Time: 0", {font: "16px Audiowide", fill: "#000"});

	stars = game.add.group();


	for (var i = 0; i < numStars; i++) 
	{
		var star = stars.create(i * 70, 0 , "star");

		star.body.gravity.y = 6;

		star.body.bounce.y = 0.7 + Math.random() * 0.2;
	};

	bonuses = game.add.group();

	//madAir = bonuses.create(300, 275, "bonus");
	//madAir.body.gravity.y = 3;
	//madAir.body.collideWorldBounds = true;

	for(var i = 0; i < numMadAirs; i++)
	{
		var madAir = bonuses.create(i * 150, 0, "bonus");

		madAir.body.gravity.y = 1;
	}

	//baddies = game.add.group();

	// antiDude = baddies.create(200, game.world.height - 150, "enemy");
	// antiDude.body.collideWorldBounds = true;
	// antiDude.body.gravity.y = 6;

}

function update() {


	game.physics.collide(player, platforms);

	game.physics.collide(stars, platforms);

	game.physics.overlap(player, stars, collectStar);

	game.physics.overlap(player, bonuses, getMadAir);

	game.physics.collide(bonuses, platforms);

	// game.physics.collide(baddies, platforms);

	game.physics.collide(myEnemies, platforms);

	//game.physics.overlap(player, antiDude, killPlayer);

	//game.physics.overlap(player, antiDude, killBaddie);

	//game.physics.overlap(player, myEnemies, decideFate);


	scoreText.x = player.x - 140;
	scoreText.y = player.y - 70;
	bounceText.x = player.x - 140;
	bounceText.y = player.y - 40;
	timerText.x = player.x - 140;
	timerText.y = player.y - 20;

	myEnemies.forEachAlive(enemyWalk, this);


	//game.physics.collide(antiDude, platforms);

	//game.physics.overlap()

	 //  Reset the players velocity (movement)
    player.body.velocity.x = 0


    if (dudeIsGood)
    {
	    if (cursors.left.isDown)
	    {
	        //  Move to the left
	        player.body.velocity.x = -150;

	        player.animations.play('left');
	    }

	    else if (cursors.right.isDown)
	    {
	        //  Move to the right
	        player.body.velocity.x = 150;

	        player.animations.play('right');
	    }
	    else
	    {
	        //  Stand still
	        player.animations.stop();

	        player.frame = 4;
	    }

	    //  Allow the player to jump if they are touching the ground.
	    if (cursors.up.isDown && player.body.touching.down)
	    {
	        player.body.velocity.y = -350;
	        isDiving = false;
	    }

	    if(cursors.down.isDown && !player.body.touching.down && game.time.now > nextDive && canDive)
	    {
	    	nextDive = game.time.now + diveRate;
	    	player.body.velocity.y = 1000;
	    	isDiving = true;
	    }
	    else if (cursors.down.isDown)
	    {
	    	canDive = false;

	    }
	    else if (game.time.now > nextDive)
	    {
	    	canDive = true;
	    	isDiving = false;
	    }

	    if(madAirsGrabbed != numMadAirs && score != numStars)
	    {
	    	timerText.content = "Time: " + (Math.floor(game.time.now)/1000).toFixed(2);
	    }
	    else if (!finished)
	    {
	    	var doneMsg = $("<div class=\"air_msg\" style=\"color:chartreuse\">LEVEL COMPLETE</div>");
	    	$("#msgContainer").append(doneMsg);
	    	doneMsg.delay(5000).fadeOut("fast");
	    	finished = true;
	    }

	    if (finished && cursors.left.isDown && cursors.right.isDown)
	    {
	    	//player.body.boun
	    	player.body.bounce.y = 0.05;
	    }

	    // collideEnemy = function(player, antiDude)
	    // {
	    // 	if (antiDude.body.touching.up)
	    // 	{
	    // 		player.body.velocity.y = -300;
	    // 		score += 1;
	    // 		antiDude.kill();
	    // 		console.log("fadsf");
	    // 	}

	    // 	else
	    // 	{
	    // 		killPlayer(player, antiDude);
	    // 	}
	    // }

	    // if (isDiving && player.body.touching.down)
	    // {
	    // 	//console.log("cheese");
	    // }


	}
	else
	{
		player.body.velocity.x = 0;
		player.body.velocity.y = 0;
		player.animations.stop();
	}

}

function collectStar (player, star)
{
	star.kill();
	score += 1;
	scoreText.content = "Score: " + score + "/" + numStars;
	//console.log(scoreText.font.font);
	scoreText.font.font = buildSize(scoreText.font.font);
}

function getMadAir (player, bonus)
{
	bonus.kill();

	madAirsGrabbed++;
	
	canDive = true;
	
	nextDive = 0;
	
	player.body.velocity.y = -400;
	
	// game.add.text(game.world.center-300, 0, "GET MAD AIR!", {font: "3em Audiowide", fill: "pink", align: "center"})

	pushAirMessage();

	//if (player.body.)

	//BOUNCE MODIFICATION
	player.body.bounce.y = madAirsGrabbed/numMadAirs;

	bounceText.content = madAirToString();
	bounceText.font.font = buildSize(bounceText.font.font);


	//platforms.
}

function pushAirMessage()
{
	//console.log($("#msgContainer"))
	//document.getElementById("msgContainer").innerHTML = "ASDASDDFGSDFDSF"

	var newAirMsg = $("<div class=\"air_msg\">MAD AIR!!!</div>");

	$("#msgContainer").append(newAirMsg);

	newAirMsg.delay(2000).fadeOut("slow");



	//$("#msgContainer").append();
	//console.log("appended");
}

function madAirToString()
{
	var myAir = player.body.bounce.y;

	if (myAir < 1)
		return "MadAir: " + ((myAir) * 10).toFixed(3) + " tks/Gx^2";
	else
		return "MadAir: GOD-TIER";
}


// function killPlayer(player, antiDude)
// {
// 	player.angle = -90;
// 	player.body.immovable = true;
// 	player.body.collideWorldBounds = false;
// 	player.alive = false;
// 	dudeIsGood = false;
// 	//game.physics.collide()
// }

// function killBaddie(player, antiDude)
// {
// 	antiDude.kill();
// 	//game.time.now -= 30000000;
// 	console.log("pizza");


// }


function decideFate(player, antiDude)
{
	console.log(score);

	if (isDiving)
	{
		canDive = true;
		player.body.velocity.y = -350;
		score++;
		scoreText.content = "Score: " + score + "/" + numStars;
		scoreText.font.font = buildSize(scoreText.font.font);
		antiDude.kill();
	}
	else
	{

		// player.body.velocity.y = -200;
		// player.angle = -90;
		// //game.camera.follow(antiDude);
		// player.body.gravity = -2;
		// dudeIsGood = false
		// //player.alive = false;
		// var _level = player.body.y;
		// player.body.velocity.y = -400;
		// while(player.y != _level){}
		player.angle = -90;
		player.body.gravity.y = 200;
		player.body.immovable = true;
		player.body.collideWorldBounds = false;
		dudeIsGood = false;
		$("body").fadeOut(3000);
	}
}

function enemyWalk(baddie)
{
	var rand_jump = (Math.random() > 0.90);
	var rand_change = (Math.random() > Math.random());
	var time_var = (game.time.now % 10000) < 5000;
	var plr_toLeft = (baddie.body.x - player.body.x) > 0;
	var withinRange = calcDist(player.body.x, player.body.y, baddie.body.x, baddie.body.y);

	if (withinRange < 125)
	{
		if (plr_toLeft)
		{
			baddie.body.velocity.x = -100;
		}
		else
		{
			baddie.body.velocity.x = 100;
		}
	}
	else
	{
		// if (game.time.now % 10000 < 5000)
		// {
		// 	baddie.body.velocity.x = -50;
		// 	//baddie.dirTimer--;
		// } 

		// else if (rand_change)
		// {

		// }
		// else
		// {
		// 	baddie.body.velocity.x = 50;
		// }

		if (rand_change ^ time_var)
		{
			baddie.body.velocity.x = -50;
		}
		else
		{
			baddie.body.velocity.x = 50;
		}


	}

	if(rand_jump && baddie.body.touching.down)
	{
		baddie.body.velocity.y = -100;
	}
}

function calcDist(pX, pY, bX, bY)
{
	var powX = Math.pow(pX-bX, 2);
	var powY = Math.pow(pY-bY, 2);

	return Math.sqrt(powX+powY);
}


function buildSize (myStr)
{
	var _fontSize = myStr.substr(0,myStr.length - myFontPost.length);
	//return myStr;

	//console.log("FIRST: " + _fontSize);

	_fontSize = (parseInt(_fontSize) + 1);
	//console.log("SECOND: " + _fontSize);

	return _fontSize + myFontPost;
}

</script>

</body>
</html>